<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroSystem | نظام متكامل</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- RESET & BASIC STYLES --- */
        :root {
            --primary: #2563EB; --secondary: #1e293b; --bg: #F8FAFC;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background-color: var(--bg); color: var(--secondary); overflow-x: hidden; }
        
        /* LOGIN STYLES */
        .login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 16px; width: 400px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.3s; margin-bottom: 15px; }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .btn-guest { background: transparent; color: #64748b; margin-top: 10px; font-size: 14px; text-decoration: underline; cursor: pointer; border: none; }
        .credentials-hint { margin-top: 20px; background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 12px; text-align: right; color: #475569; }

        /* APP STYLES */
        .app-container { display: none; }
        .navbar {
            background: white; height: 70px; padding: 0 5%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
        }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .role-badge { padding: 4px 10px; border-radius: 20px; color: white; font-size: 12px; }
        
        /* CART BUTTON IN NAVBAR */
        .nav-cart-btn {
            background: var(--bg); color: var(--secondary); padding: 8px 15px; border-radius: 8px; cursor: pointer;
            border: 1px solid #e2e8f0; display: none; /* Hidden by default */
            align-items: center; gap: 8px; font-weight: 600;
        }
        .nav-cart-btn:hover { background: #e2e8f0; }

        .view-section { display: none; padding: 30px 5%; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s; }
        .view-section.active { display: block; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 200px; object-fit: contain; padding: 10px; background: #f8fafc; }
        .card-body { padding: 15px; }
        .card-price { color: var(--primary); font-weight: 800; font-size: 18px; }
        
        /* FILE UPLOAD STYLE */
        .file-upload-wrapper {
            border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s;
            margin-bottom: 15px; position: relative;
        }
        .file-upload-wrapper:hover { border-color: var(--primary); background: #f0f9ff; }
        .file-upload-wrapper input { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0; cursor: pointer; }
        
        /* CART MODAL STYLES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 450px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding: 10px 0; }
        .cart-item img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
        .cart-total { font-size: 20px; font-weight: 800; margin-top: 20px; text-align: center; border-top: 2px solid #f1f5f9; padding-top: 15px; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; display: none; z-index: 4000; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div class="login-wrapper" id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:20px;">ElectroSystem</h2>
            <h3 style="margin-bottom: 20px;">تسجيل الدخول</h3>
            
            <input type="text" id="email" class="input-field" placeholder="Email">
            <input type="password" id="password" class="input-field" placeholder="Password">
            
            <button class="btn-login" onclick="handleLogin()">دخول</button>
            <button class="btn-guest" onclick="continueAsGuest()">تصفح كزائر</button>

            <div class="credentials-hint">
                <div style="font-weight:bold; margin-bottom:5px;">بيانات التجربة:</div>
                <div>Owner: <b>owner@sys.com / 123</b></div>
                <div>Seller: <b>seller@sys.com / 123</b></div>
                <div>Customer: <b>cust@sys.com / 123</b></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="app-container">
        
        <nav class="navbar">
            <h2 style="color:var(--primary);"><i class="fas fa-bolt"></i> ElectroSys</h2>
            
            <div class="user-info">
                <!-- CART BUTTON (Visible Only for Customer) -->
                <button id="nav-cart-btn" class="nav-cart-btn" onclick="openCartModal()">
                    <i class="fas fa-shopping-cart"></i> السلة (<span id="cart-count">0</span>)
                </button>

                <div style="text-align: left;">
                    <span id="display-name" style="display:block; font-weight:bold; font-size:14px;">User</span>
                    <span id="display-role" class="role-badge">Role</span>
                </div>
                <button onclick="logout()" style="background:#fee2e2; color:#ef4444; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <!-- OWNER VIEW -->
        <section id="owner-view" class="view-section">
            <h2>لوحة تحكم المالك (Owner)</h2>
            <p style="margin-bottom:20px; color:#666;">إدارة طلبات البائعين</p>
            <table>
                <thead>
                    <tr><th>ID</th><th>اسم البائع</th><th>الحالة</th><th>الإجراء</th></tr>
                </thead>
                <tbody id="seller-requests-body"></tbody>
            </table>
        </section>

        <!-- SELLER VIEW -->
        <section id="seller-view" class="view-section">
            <h2>لوحة تحكم البائع (Seller)</h2>
            
            <div style="background: white; padding: 25px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <h3 style="margin-bottom: 15px;">إضافة منتج جديد</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom:15px;">
                    <input type="text" id="p-name" class="input-field" placeholder="اسم المنتج" style="margin:0;">
                    <input type="number" id="p-price" class="input-field" placeholder="السعر" style="margin:0;">
                </div>
                
                <div class="file-upload-wrapper">
                    <input type="file" id="p-file" accept="image/*" onchange="previewImage(event)">
                    <div id="upload-text">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color:var(--primary);"></i><br>
                        اضغط لرفع صورة المنتج من جهازك
                    </div>
                    <img id="img-preview" style="max-height: 100px; margin-top: 10px; display: none; margin: 10px auto;">
                </div>

                <button class="btn-login" style="width:auto; background:var(--success);" onclick="addNewProduct()">نشر المنتج الآن</button>
            </div>

            <h3>منتجاتي المعروضة</h3>
            <div class="grid" id="seller-products-grid"></div>
        </section>

        <!-- CUSTOMER VIEW -->
        <section id="customer-view" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>تصفح المنتجات</h2>
                <div style="font-size:14px; color:#666;" id="customer-status-msg"></div>
            </div>
            <div class="grid" id="customer-products-grid"></div>
        </section>

    </div>

    <!-- CART MODAL -->
    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>سلة المشتريات</h2>
                <button onclick="closeCartModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            
            <div id="cart-items-container">
                <!-- Items will be here -->
            </div>

            <div class="cart-total">
                الإجمالي: <span id="cart-total-price">0</span> ج.م
            </div>
            
            <button class="btn-login" style="margin-top:20px; background:var(--success);" onclick="checkout()">إتمام الشراء</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // --- 1. DATA ---
        const usersDB = [
            { email: "owner@sys.com", pass: "123", name: "Nesma", role: "owner" },
            { email: "seller@sys.com", pass: "123", name: "Samsung Store", role: "seller" },
            { email: "cust@sys.com", pass: "123", name: "Menna", role: "customer" }
        ];

        let products = [
            { id: 1, name: "iPhone 14 Pro", price: 42000, img: "https://images.pexels.com/photos/699122/pexels-photo-699122.jpeg?_gl=1*bve22o*_ga*MzEwNjM5NTA0LjE3NjU5MjEyODE.*_ga_8JE65Q40S6*czE3NjU5MjEyODEkbzEkZzEkdDE3NjU5MjIyNzIkajU5JGwwJGgw" },
            { id: 2, name: "Smart TV LG", price: 18000, img: "https://images.pexels.com/photos/3586249/pexels-photo-3586249.jpeg?_gl=1*1ibn70*_ga*MzEwNjM5NTA0LjE3NjU5MjEyODE.*_ga_8JE65Q40S6*czE3NjU5MjEyODEkbzEkZzEkdDE3NjU5MjIzMzQkajU5JGwwJGgw" }
        ];

        let sellerRequests = [
            { id: 101, name: "Tech Shop", status: "Pending" },
            { id: 102, name: "Mobile Center", status: "Pending" }
        ];

        let currentUser = null;
        let cart = []; // The Cart Array
        let uploadedImageBase64 = null;

        // --- 2. AUTH LOGIC ---
        function handleLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const user = usersDB.find(u => u.email === email && u.pass === pass);
            if (user) loginSuccess(user);
            else alert("بيانات خاطئة!");
        }

        function continueAsGuest() {
            loginSuccess({ name: "زائر (Guest)", role: "guest" });
        }

        function loginSuccess(user) {
            currentUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').style.display = 'block';
            
            // Navbar Update
            document.getElementById('display-name').innerText = user.name;
            const roleBadge = document.getElementById('display-role');
            roleBadge.innerText = user.role.toUpperCase();
            
            // Colors
            const colors = { owner: '#EF4444', seller: '#10B981', customer: '#2563EB', guest: '#64748b' };
            roleBadge.style.background = colors[user.role];

            // Show/Hide Cart Button
            const cartBtn = document.getElementById('nav-cart-btn');
            if(user.role === 'customer') {
                cartBtn.style.display = 'flex';
                updateCartCount();
            } else {
                cartBtn.style.display = 'none';
            }

            // Routing
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            
            if (user.role === 'owner') {
                document.getElementById('owner-view').classList.add('active');
                renderRequests();
            } else if (user.role === 'seller') {
                document.getElementById('seller-view').classList.add('active');
                renderSellerProducts();
            } else {
                document.getElementById('customer-view').classList.add('active');
                renderCustomerProducts();
            }
        }

        function logout() {
            currentUser = null;
            cart = []; // Empty cart on logout
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // --- 3. SELLER LOGIC ---
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImageBase64 = e.target.result;
                    const imgPreview = document.getElementById('img-preview');
                    imgPreview.src = uploadedImageBase64;
                    imgPreview.style.display = 'block';
                    document.getElementById('upload-text').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        function addNewProduct() {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;

            if(!name || !price || !uploadedImageBase64) {
                alert("بيانات ناقصة"); return;
            }

            products.push({
                id: Date.now(),
                name: name,
                price: parseInt(price),
                img: uploadedImageBase64
            });

            renderSellerProducts();
            showToast("تم نشر المنتج بنجاح!");
            
            // Reset
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('img-preview').style.display = 'none';
            document.getElementById('upload-text').style.display = 'block';
            document.getElementById('p-file').value = '';
            uploadedImageBase64 = null;
        }

        // --- 4. RENDER LOGIC ---
        function renderSellerProducts() {
            const container = document.getElementById('seller-products-grid');
            container.innerHTML = products.map(p => `
                <div class="card">
                    <img src="${p.img}">
                    <div class="card-body">
                        <h3>${p.name}</h3>
                        <div class="card-price">${p.price.toLocaleString()} ج.م</div>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomerProducts() {
            const container = document.getElementById('customer-products-grid');
            container.innerHTML = products.map(p => `
                <div class="card">
                    <img src="${p.img}">
                    <div class="card-body">
                        <h3>${p.name}</h3>
                        <div class="card-price">${p.price.toLocaleString()} ج.م</div>
                        <button class="btn-login" style="margin-top:10px; font-size:14px; background:${currentUser.role === 'guest' ? '#94a3b8' : 'var(--primary)'}" onclick="addToCart(${p.id})">
                            <i class="fas fa-shopping-cart"></i> أضف للسلة
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- 5. CART LOGIC (THE MISSING PART RESTORED!) ---
        
        function addToCart(id) {
            if(currentUser.role === 'guest') {
                alert("يجب تسجيل الدخول كـ Customer للشراء");
                return;
            }

            // Find Product
            const product = products.find(p => p.id === id);
            
            // Check if exist
            const existItem = cart.find(item => item.id === id);
            if(existItem) {
                existItem.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            
            updateCartCount();
            showToast("تمت الإضافة للسلة");
        }

        function updateCartCount() {
            const count = cart.reduce((acc, item) => acc + item.qty, 0);
            document.getElementById('cart-count').innerText = count;
        }

        function openCartModal() {
            const container = document.getElementById('cart-items-container');
            let total = 0;

            if(cart.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:20px; color:#777;'>السلة فارغة</p>";
            } else {
                container.innerHTML = cart.map(item => {
                    total += item.price * item.qty;
                    return `
                        <div class="cart-item">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img src="${item.img}">
                                <div>
                                    <div style="font-weight:bold;">${item.name}</div>
                                    <div style="font-size:12px; color:#666;">${item.price.toLocaleString()} x ${item.qty}</div>
                                </div>
                            </div>
                            <div style="font-weight:bold; color:var(--primary);">${(item.price * item.qty).toLocaleString()}</div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('cart-total-price').innerText = total.toLocaleString();
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function closeCartModal() {
            document.getElementById('cart-modal').style.display = 'none';
        }

        function checkout() {
            if(cart.length === 0) return;
            alert("تم إرسال الطلب بنجاح! سيتم التواصل معك.");
            cart = [];
            updateCartCount();
            closeCartModal();
        }

        // --- 6. OWNER LOGIC ---
        function renderRequests() {
            const tbody = document.getElementById('seller-requests-body');
            tbody.innerHTML = sellerRequests.map(req => `
                <tr>
                    <td>#${req.id}</td><td>${req.name}</td>
                    <td><span style="background:${req.status==='Pending'?'#fff7ed':'#ecfccb'}; padding:4px 8px; border-radius:4px;">${req.status}</span></td>
                    <td>${req.status==='Pending' ? `<button onclick="approve(${req.id})" style="cursor:pointer; color:green; background:none; border:none; font-weight:bold;">قبول</button>` : '<i class="fas fa-check"></i>'}</td>
                </tr>
            `).join('');
        }
        function approve(id) {
            const r = sellerRequests.find(x => x.id === id);
            if(r) { r.status = "Active"; renderRequests(); showToast("تم التفعيل"); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>